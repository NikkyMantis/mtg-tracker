<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title th:text="${isCollection == true} ? 'My Collection' : 'Search Cards'">Cards</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/theme.css}">
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
  <div class="container">
    <a class="navbar-brand" th:href="@{/}">MTG Tracker</a>

    <ul class="navbar-nav ms-auto">
      <li class="nav-item">
        <a class="nav-link" th:href="@{/cards}">Search Cards</a>
      </li>
      <li class="nav-item" sec:authorize="isAuthenticated()">
        <a class="nav-link" th:href="@{/cards/collection}">My Collection</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container">

  <!-- SUCCESS MESSAGE -->
  <div th:if="${success == true}"
       class="alert alert-success alert-dismissible fade show">
    Added "<span th:text="${addedCard}">Card</span>" to your collection!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- PAGE TITLE -->
  <h1 class="mb-3"
      th:text="${isCollection == true} ? 'My Collection' : 'Search Cards'"></h1>

  <!-- SEARCH FORM -->
  <div th:if="${isCollection == false}">
    <form class="row g-3 mb-4" th:action="@{/cards}" method="get">
      <div class="col-md-3">
        <input type="text" name="name" class="form-control"
               placeholder="Name" th:value="${name}">
      </div>
      <div class="col-md-2">
        <input type="text" name="color" class="form-control"
               placeholder="Color" th:value="${color}">
      </div>
      <div class="col-md-2">
        <input type="text" name="type" class="form-control"
               placeholder="Type" th:value="${type}">
      </div>
      <div class="col-md-2">
        <select name="rarity" class="form-select">
          <option value="">All Rarities</option>
          <option value="common" th:selected="${rarity=='common'}">Common</option>
          <option value="uncommon" th:selected="${rarity=='uncommon'}">Uncommon</option>
          <option value="rare" th:selected="${rarity=='rare'}">Rare</option>
          <option value="mythic" th:selected="${rarity=='mythic'}">Mythic</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100">Search</button>
      </div>
    </form>
  </div>

  <!-- INFO MESSAGE -->
  <div th:if="${showSearchOnly == true}"
       class="alert alert-info">
    Use the form above to search for cards.
  </div>

  <!-- CARD GRID (SEARCH RESULTS) -->
  <div th:if="${isCollection == false and cards != null and !cards.empty}">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-4">
      <div class="col" th:each="card : ${cards}">
        <div class="card h-100">

          <img th:if="${card.imageUrl != null}"
               th:src="${card.imageUrl}"
               class="card-img-top">

          <div class="card-body">
            <h6 class="card-title text-center"
                th:text="${card.name}"></h6>

            <!-- VIEW PRINTINGS BUTTON (replaces Add) -->
            <a class="btn btn-success btn-sm w-100"
               th:href="@{/cards/printings/{oracleId}(oracleId=${card.oracleId})}">
              View Printings
            </a>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- COLLECTION VIEW -->
  <div th:if="${isCollection == true}">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-4">

      <th:block th:each="oracleCard : ${collection}">
        <th:block th:each="printing : ${oracleCard.printings}">
          <div class="col">
            <div class="card h-100">

              <img th:src="${@cardService.getCardById(printing.scryfallId).imageUrl}"
                   class="card-img-top">

              <div class="card-body">
                <h6 class="card-title text-center"
                    th:text="${oracleCard.name}"></h6>

                <p class="text-center small mb-2">
                  <span th:text="${printing.setName}"></span>
                  (#<span th:text="${printing.collectorNumber}"></span>)
                  Ã— <span th:text="${printing.quantity}"></span>
                </p>

                <form th:action="@{/cards/remove}" method="post">
                  <input type="hidden" name="cardId"
                         th:value="${printing.scryfallId}">
                  <button class="btn btn-danger btn-sm w-100">Remove</button>
                </form>

              </div>
            </div>
          </div>
        </th:block>
      </th:block>

    </div>
  </div>

  <!-- NO RESULTS (SEARCH ONLY) -->
  <div th:if="${isCollection == false and showSearchOnly != true and (cards == null or cards.empty)}"
       class="alert alert-warning">
    No cards found.
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
